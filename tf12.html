<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Lecteur Minimaliste OQEE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
    <style>
        body, html { margin: 0; padding: 0; background: #000; height: 100%; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #status { position: absolute; top: 10px; left: 10px; color: lime; font-family: monospace; z-index: 100; background: rgba(0,0,0,0.7); padding: 5px; }
    </style>
</head>
<body>
    
    <div id="status">Initialisation...</div>
    
    <video id="video" controls autoplay muted></video>

    <script>
        const statusDiv = document.getElementById('status');
        const video = document.getElementById('video');

        const CONFIG = {
            "mpd_url": "https://api-proxad.oqee.net/playlist/v1/live/201/1/live.mpd",
            "licence_url": "https://license.oqee.net/api/v1/live/license/widevine",
            // ⚠️ METTEZ VOS TOKENS ICI ⚠️
            "auth_bearer": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ2ZXJzaW9uIjo0LCJpYXQiOjE3NzE2ODg4NjcsImV4cCI6MTc3MTgyOTExOSwidXNlcl9pZCI6ImR6djdKVldRZ0JOeTl4TlciLCJyZWdpb24iOiJGUi1WIiwiZnJlZSI6eyJhdXRoX3R5cGUiOiJmcmVlb2EifSwiZGV2aWNlX3R5cGUiOiJ1bmtub3duIiwibHYiOjUsInR2X3BsYW4iOjIwLCJhY2NvdW50X3Byb3ZpZGVyIjoiZnJlZSJ9.CVw8sAhijNQ-C86-zYT8eD_Y155sztJUPjOUiqFyQK8",
            "fbx_token": "eyJhbGciOiJIUzI1NiIsImtpZCI6ImZyMSIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3NzE2ODg4NjgsImV4cCI6MTc3MTc2MTQ0NywidXNlcl9pZCI6ImR6djdKVldRZ0JOeTl4TlciLCJyaWdodHMiOnsidWlkIjozMTYzNDU2OCwiY2hhbm5lbHMiOltdLCJwYWNrcyI6Wzk4XX0sImNhbmFsX3JpZ2h0cyI6eyJjaGFubmVscyI6e319LCJzZXJ2aWNlcyI6WyJmcmVlYXZvZCJdLCJhY2NvdW50X3Byb3ZpZGVyIjoiZnJlZSIsInR2X3BsYW4iOjIwLCJpZmYiOjMxNjM0NTY4LCJpZmMiOm51bGwsImhhc19wdXJjaGFzZV9jb2RlIjp0cnVlLCJoYXNfcGFyZW50YWxfY29kZSI6ZmFsc2V9.BP0uH4yiPpDlsxCtkQ04r3RYaPHFwRvL-Z1PFxHi_jM.vQjf3hjPHLQ-amR9J6-UBcBUCWHf2_QKqs2MRGCizeo",
            "profile_token": "ey5j5NqNTD8A7mpR"
        };

        async function initApp() {
            shaka.polyfill.installAll();

            if (!shaka.Player.isBrowserSupported()) {
                statusDiv.innerText = "❌ Navigateur non supporté";
                statusDiv.style.color = "red";
                return;
            }

            const player = new shaka.Player(video);

            // Écoute des erreurs critiques de Shaka Player
            player.addEventListener('error', (event) => {
                console.error('Erreur Shaka:', event.detail);
                statusDiv.innerText = `❌ Erreur code ${event.detail.code}`;
                statusDiv.style.color = "red";
            });

            // 1. CONFIGURATION DU PILOTE AUTOMATIQUE (DRM)
            player.configure({
                drm: {
                    servers: {
                        'com.widevine.alpha': CONFIG.licence_url
                    }
                }
            });

            // 2. LE FILTRE RÉSEAU (Le fameux déguisement)
            player.getNetworkingEngine().registerRequestFilter(function(type, request) {
                // On met le déguisement sur les segments vidéo ET sur la demande de licence DRM
                if (type == shaka.net.NetworkingEngine.RequestType.MANIFEST || 
                    type == shaka.net.NetworkingEngine.RequestType.SEGMENT ||
                    type == shaka.net.NetworkingEngine.RequestType.LICENSE) {
                    
                    request.headers['Authorization'] = 'Bearer ' + CONFIG.auth_bearer;
                    request.headers['X-Fbx-Rights-Token'] = CONFIG.fbx_token;
                    request.headers['X-Oqee-Profile'] = CONFIG.profile_token;
                    request.headers['X-Oqee-Account-Provider'] = 'free';
                    request.headers['X-Oqee-Platform'] = 'web';
                }

                // Formatage de la requête de licence (Le fameux "licenseRequest" qu'on a vu en Python !)
                if (type == shaka.net.NetworkingEngine.RequestType.LICENSE) {
                    // Shaka envoie le challenge en binaire, on le passe en Base64 puis en JSON
                    const challengeBinaire = request.body;
                    const challengeB64 = shaka.util.Uint8ArrayUtils.toBase64(new Uint8Array(challengeBinaire));
                    const payload = JSON.stringify({ "licenseRequest": challengeB64 });
                    
                    // On modifie le corps de la requête pour faire plaisir au serveur Free
                    request.body = shaka.util.StringUtils.toUTF8(payload);
                    request.headers['Content-Type'] = 'application/json';
                }
            });

            // Le filtre pour décoder la réponse de la licence
            player.getNetworkingEngine().registerResponseFilter(function(type, response) {
                if (type == shaka.net.NetworkingEngine.RequestType.LICENSE) {
                    // Free nous renvoie un JSON, on extrait la licence Base64 et on la donne à Shaka en binaire
                    const responseString = shaka.util.StringUtils.fromUTF8(response.data);
                    const json = JSON.parse(responseString);
                    
                    let licenseB64 = '';
                    if (json.result && json.result.license) {
                        licenseB64 = json.result.license;
                    } else if (json.license) {
                        licenseB64 = json.license;
                    }

                    if (licenseB64) {
                        response.data = shaka.util.Uint8ArrayUtils.fromBase64(licenseB64).buffer;
                    }
                }
            });

            // 3. CHARGEMENT DE LA VIDÉO
            try {
                statusDiv.innerText = "⏳ Chargement...";
                await player.load(CONFIG.mpd_url);
                statusDiv.innerText = "✅ Connecté !";
                setTimeout(() => statusDiv.style.display = 'none', 3000);
            } catch (e) {
                console.error('Erreur de chargement', e);
                statusDiv.innerText = "❌ Échec de chargement";
                statusDiv.style.color = "red";
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
