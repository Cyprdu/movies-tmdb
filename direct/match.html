<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Lecteur Live</title>
    <link rel="icon" type="image/png" href="favico.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Shaka Player AVANT le Cast Framework -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>

    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --accent: #E50914;
            --ui-bg-top: linear-gradient(to bottom, rgba(0,0,0,.85) 0%, transparent 100%);
            --ui-bg-bottom: linear-gradient(to top, rgba(0,0,0,.92) 0%, transparent 100%);
            --control-size: 25px;
            --radius: 6px;
        }

        html, body {
            width: 100%; height: 100%;
            background: #000;
            font-family: 'DM Sans', sans-serif;
            overflow: hidden;
            color: #fff;
            user-select: none;
            -webkit-user-select: none;
        }

        body.hide-cursor, body.hide-cursor * { cursor: none !important; }

        /* Sécurité */
        #security-warning {
            position: fixed; inset: 0;
            background: #000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; text-align: center; gap: 12px;
        }
        #security-warning h1 { font-size: 24px; }
        #security-warning p { color: #888; font-size: 15px; }

        /* Conteneur principal */
        #player-container {
            position: relative;
            width: 100%; height: 100%;
            background: #000;
            overflow: hidden;
        }

        video {
            width: 100%; height: 100%;
            display: block;
            object-fit: contain;
            position: relative;
            z-index: 1;
        }

        /* ===== ÉCRAN CAST ===== */
        #cast-screen {
            position: absolute; inset: 0;
            background: radial-gradient(ellipse at 50% 40%, #1a1a2e 0%, #000 70%);
            z-index: 10;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            pointer-events: none;
        }
        #cast-screen.visible { display: flex; }

        #cast-screen .cast-icon-wrap {
            width: 72px; height: 72px;
            border-radius: 50%;
            background: rgba(229, 9, 20, .15);
            display: flex; align-items: center; justify-content: center;
            animation: castPulse 2.4s ease-in-out infinite;
        }
        #cast-screen .cast-icon-wrap svg { width: 36px; height: 36px; opacity: .9; }
        #cast-screen h2 { font-size: 22px; font-weight: 600; letter-spacing: -.2px; }
        #cast-screen p { font-size: 14px; color: #999; }

        @keyframes castPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(229,9,20,.3); transform: scale(1); }
            50%       { box-shadow: 0 0 0 18px rgba(229,9,20,.0); transform: scale(1.04); }
        }

        /* Sous-titres */
        #subtitle-container {
            position: absolute;
            width: 100%;
            bottom: 100px;
            display: flex;
            justify-content: center;
            pointer-events: none;
            z-index: 200;
            transition: bottom .2s ease;
        }
        #subtitle-container.shifted { bottom: 148px; }
        #subtitle-container span {
            font-size: clamp(22px, 3.8vw, 40px);
            color: #fff;
            text-shadow: 0 0 8px rgba(0,0,0,.95), 0 0 14px rgba(0,0,0,.8);
            font-weight: 500;
            padding: 4px 14px;
            white-space: pre-line;
            text-align: center;
        }

        /* Couche de clic */
        #click-layer {
            position: absolute; inset: 0;
            z-index: 15;
        }

        /* ===== UI LAYER ===== */
        #ui-layer {
            position: absolute; inset: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            opacity: 0;
            transition: opacity .22s ease;
            pointer-events: none;
        }
        #ui-layer.visible { opacity: 1; }

        /* TOP BAR */
        .top-bar {
            padding: 22px 36px 50px;
            background: var(--ui-bg-top);
            display: flex;
            align-items: center;
            justify-content: space-between;
            pointer-events: auto;
            position: relative;
        }

        .top-title {
            position: absolute;
            left: 50%; top: 26px;
            transform: translateX(-50%);
            font-size: 17px; font-weight: 600;
            letter-spacing: -.1px;
            text-shadow: 0 1px 6px rgba(0,0,0,.7);
            pointer-events: none;
            white-space: nowrap;
        }

        .top-icons {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .icon-btn {
            width: var(--control-size);
            height: var(--control-size);
            color: rgba(255,255,255,.75);
            cursor: pointer;
            transition: transform .15s, color .15s;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .icon-btn:hover { transform: scale(1.15); color: #fff; }
        .icon-btn svg { width: 100%; height: 100%; display: block; }

        /* Bouton Cast — toujours visible, rouge si actif */
        #cast-btn { display: flex; }
        #cast-btn.active { color: var(--accent) !important; }
        #cast-btn.hidden-cast { opacity: .3; pointer-events: none; }

        .sep {
            width: 1px; height: 20px;
            background: rgba(255,255,255,.3);
        }

        /* Volume */
        .vol-wrap {
            position: relative;
            display: flex; flex-direction: column; align-items: center;
        }
        .vol-slider-track {
            position: absolute;
            top: 34px;
            width: 38px;
            height: 0;
            background: rgba(28,28,28,.97);
            border-radius: var(--radius);
            transition: height .2s ease;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,.7);
            z-index: 300;
        }
        .vol-wrap:hover .vol-slider-track,
        .vol-slider-track:hover { height: 130px; }

        input[type=range].vol-range {
            -webkit-appearance: none;
            appearance: none;
            transform: rotate(-90deg);
            width: 100px;
            height: 4px;
            background: transparent;
            outline: none;
            cursor: pointer;
        }
        input[type=range].vol-range::-webkit-slider-runnable-track {
            height: 4px;
            background: rgba(255,255,255,.2);
            border-radius: 2px;
        }
        input[type=range].vol-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            background: #fff;
            border-radius: 50%;
            margin-top: -5px;
            box-shadow: 0 0 4px rgba(0,0,0,.5);
        }

        /* CENTRE */
        .center-controls {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 72px;
            pointer-events: auto;
            z-index: 60;
        }
        .center-btn {
            cursor: pointer;
            color: rgba(255,255,255,.88);
            display: flex; align-items: center; justify-content: center;
            transition: transform .15s, color .15s;
        }
        .center-btn:hover { transform: scale(1.1); color: #fff; }
        .center-btn svg { filter: drop-shadow(0 2px 10px rgba(0,0,0,.8)); }
        .skip-btn { width: 50px; height: 50px; }

        /* BOTTOM BAR */
        .bottom-bar {
            padding: 0 36px 32px;
            background: var(--ui-bg-bottom);
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
            z-index: 100;
        }

        .time-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #ccc;
            font-weight: 500;
        }

        /* Badge DIRECT */
        .live-badge {
            background: var(--accent);
            color: #fff;
            padding: 2px 9px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: .6px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: transform .15s, background .2s, color .2s;
        }
        .live-badge::before {
            content: '';
            width: 6px; height: 6px;
            background: #fff;
            border-radius: 50%;
            animation: blink 1.4s infinite;
        }
        .live-badge.delayed {
            background: rgba(255,255,255,.18);
            color: #bbb;
            cursor: pointer;
        }
        .live-badge.delayed::before { animation: none; background: #888; }
        .live-badge.delayed:hover { background: rgba(255,255,255,.28); color: #fff; transform: scale(1.05); }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.25} }

        .live-offset {
            font-variant-numeric: tabular-nums;
            font-family: monospace;
            font-size: 13px;
        }

        /* Barre de progression */
        .seek-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,.22);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            transition: height .15s;
        }
        .seek-bar:hover { height: 6px; }
        .seek-fill {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            width: 0%;
            position: relative;
            transition: none;
        }
        .seek-fill::after {
            content: '';
            position: absolute;
            right: -7px; top: 50%;
            transform: translateY(-50%);
            width: 14px; height: 14px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            transition: opacity .15s;
            box-shadow: 0 1px 6px rgba(0,0,0,.5);
        }
        .seek-bar:hover .seek-fill::after { opacity: 1; }

        /* ===== MENUS ===== */
        .menu-popup {
            position: absolute;
            top: 68px; right: 36px;
            background: rgba(22,22,22,.97);
            backdrop-filter: blur(14px);
            border-radius: var(--radius);
            padding: 8px 0;
            min-width: 320px;
            display: none;
            flex-direction: column;
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,.7);
            pointer-events: auto;
            border: 1px solid rgba(255,255,255,.07);
        }
        .menu-popup.open { display: flex; }

        .menu-header {
            padding: 12px 20px 8px;
            font-weight: 700;
            font-size: 15px;
        }
        .menu-section {
            padding: 8px 20px 4px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: .8px;
            text-transform: uppercase;
            color: #666;
        }
        .menu-sep {
            height: 1px;
            background: rgba(255,255,255,.08);
            margin: 8px 0;
        }
        .menu-item {
            background: none;
            border: none;
            color: #aaa;
            text-align: left;
            padding: 10px 20px 10px 46px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 400;
            display: flex; flex-direction: column;
            width: 100%;
            transition: background .12s, color .12s;
            position: relative;
        }
        .menu-item:hover { background: rgba(255,255,255,.07); color: #fff; }
        .menu-item.active { color: #fff; font-weight: 600; }
        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 18px; top: 50%;
            transform: translateY(-50%);
            width: 18px; height: 14px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='14' viewBox='0 0 18 14'%3E%3Cpath fill='%23fff' fill-rule='evenodd' d='M1.5 5.5l5 5L16.5 1'/%3E%3C/svg%3E") center/contain no-repeat;
        }
        .menu-sub {
            font-size: 12px;
            color: #555;
            margin-top: 2px;
            font-weight: 400;
        }
        .menu-item.active .menu-sub { color: #777; }
    </style>
</head>
<body id="main-body" oncontextmenu="return false;">

    <div id="security-warning">
        <h1>Lecture impossible</h1>
        <p>Votre navigateur n'est pas sécurisé pour la lecture de ce contenu.</p>
    </div>

    <div id="player-container">
        <video id="video" playsinline></video>

        <!-- Écran affiché pendant le cast -->
        <div id="cast-screen">
            <div class="cast-icon-wrap">
                <!-- Icône Cast standard Material Design -->
                <svg viewBox="0 0 24 24" fill="white" width="36" height="36">
                    <path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm18-7H5c-1.1 0-2 .9-2 2v3h2v-3h14v10h-5v2h5c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zm-18 0v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11z"/>
                </svg>
            </div>
            <h2>Lecture sur le téléviseur</h2>
            <p>Utilisez les contrôles ci-dessous pour gérer la lecture</p>
        </div>

        <div id="subtitle-container"></div>
        <div id="click-layer"></div>

        <div id="ui-layer">
            <!-- TOP BAR -->
            <div class="top-bar">
                <div style="width:120px"></div>
                <div class="top-title" id="movie-title">Chargement…</div>
                <div class="top-icons">

                    <!-- Cast -->
                    <!-- Icône Cast standard Material Design (même icône que Chrome/Android) -->
                    <div class="icon-btn hidden-cast" id="cast-btn" title="Caster sur un téléviseur">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                            <path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm18-7H5c-1.1 0-2 .9-2 2v3h2v-3h14v10h-5v2h5c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zm-18 0v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11z"/>
                        </svg>
                    </div>

                    <!-- Sous-titres -->
                    <div class="icon-btn" id="subs-btn" title="Sous-titres & Audio">
                        <svg viewBox="0 0 25 25" fill="none">
                            <path fill="currentColor" fill-rule="evenodd" d="M20.773 2.207h-16a4 4 0 0 0-4 4v12a4 4 0 0 0 4 4h16a4 4 0 0 0 4-4v-12a4 4 0 0 0-4-4zm-16 2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-12a2 2 0 0 0-2-2h-16zm3 9a1 1 0 0 1 1-1h8a1 1 0 1 1 0 2h-8a1 1 0 0 1-1-1zm-2 3a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2h-2zm5 1a1 1 0 0 1 1-1h8a1 1 0 1 1 0 2h-8a1 1 0 0 1-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>

                    <!-- Volume -->
                    <div class="vol-wrap">
                        <div class="icon-btn" id="vol-btn" title="Volume">
                            <svg id="vol-icon" viewBox="0 0 25 24" fill="none"></svg>
                        </div>
                        <div class="vol-slider-track">
                            <input type="range" class="vol-range" id="vol-range" min="0" max="1" step="0.05" value="1">
                        </div>
                    </div>

                    <!-- Qualité -->
                    <div class="icon-btn" id="settings-btn" title="Qualité">
                        <svg viewBox="0 0 25 25" fill="none">
                            <path fill="currentColor" fill-rule="evenodd" d="M8.6 4.994c-.337.166-.66.353-.97.56l-1.947-.812a1.5 1.5 0 0 0-1.877.634L1.822 8.812a1.5 1.5 0 0 0 .39 1.943l1.678 1.28a8.596 8.596 0 0 0 0 1.118l-1.678 1.28a1.5 1.5 0 0 0-.39 1.943l1.984 3.436a1.5 1.5 0 0 0 1.877.634l1.947-.813c.31.207.633.395.97.56l.269 2.092a1.5 1.5 0 0 0 1.488 1.309h3.967a1.5 1.5 0 0 0 1.488-1.309l.269-2.091c.336-.166.66-.354.97-.561l1.947.813a1.5 1.5 0 0 0 1.877-.634l1.983-3.436a1.5 1.5 0 0 0-.389-1.943l-1.678-1.28a8.63 8.63 0 0 0 0-1.118l1.678-1.28a1.5 1.5 0 0 0 .39-1.943l-1.984-3.436a1.5 1.5 0 0 0-1.877-.634l-1.948.813a8.454 8.454 0 0 0-.969-.561l-.27-2.092a1.5 1.5 0 0 0-1.487-1.308h-3.967a1.5 1.5 0 0 0-1.488 1.308l-.27 2.092zm1.834 1.416A6.48 6.48 0 0 0 7.94 7.852L5.318 6.757 3.774 9.43l2.258 1.722a6.49 6.49 0 0 0 0 2.881l-2.258 1.723 1.544 2.674 2.622-1.095a6.462 6.462 0 0 0 2.494 1.441l.362 2.817h3.088l.363-2.817c.94-.29 1.79-.788 2.493-1.441l2.623 1.095 1.544-2.674-2.259-1.723a6.489 6.489 0 0 0 0-2.88l2.259-1.723-1.544-2.674-2.623 1.095a6.461 6.461 0 0 0-2.493-1.441l-.363-2.817h-3.088l-.362 2.816zm1.906 10.184a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0-2a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" clip-rule="evenodd"/>
                        </svg>
                    </div>

                    <!-- PiP -->
                    <div class="icon-btn" id="pip-btn" title="Image dans l'image">
                        <svg viewBox="0 0 24 24" fill="none">
                            <rect x="11" y="12" width="9" height="6" rx="1" fill="currentColor"/>
                            <rect x="1" y="3" width="22" height="18" rx="3" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>

                    <!-- Plein écran -->
                    <div class="icon-btn" id="fullscreen-btn" title="Plein écran">
                        <svg viewBox="0 0 25 25" fill="none">
                            <path fill="currentColor" d="M4.746 8.056V6.294L18.73 20.278h-1.762a1.111 1.111 0 1 0 0 2.222h4.444a1.11 1.11 0 0 0 1.111-1.111v-4.445a1.111 1.111 0 0 0-2.222 0v1.762L6.317 4.722h1.762a1.111 1.111 0 1 0 0-2.222H3.635c-.614 0-1.112.497-1.112 1.111v4.445a1.111 1.111 0 1 0 2.223 0z"/>
                        </svg>
                    </div>

                    <div class="sep"></div>

                    <a href="javascript:window.close();" class="icon-btn" title="Fermer" style="text-decoration:none;">
                        <svg viewBox="0 0 25 25" fill="none">
                            <path fill="currentColor" fill-rule="evenodd" d="M4.691 4.667a1 1 0 0 1 1.415 0l6.418 6.419 6.42-6.42a1 1 0 1 1 1.414 1.415l-6.42 6.419 6.42 6.419a1 1 0 0 1-1.415 1.414l-6.419-6.419-6.418 6.42a1 1 0 0 1-1.415-1.415l6.42-6.419-6.42-6.419a1 1 0 0 1 0-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- CONTRÔLES CENTRE -->
            <div class="center-controls">
                <div class="center-btn skip-btn" id="skip-back">
                    <svg width="50" height="50" viewBox="0 0 67 67" fill="none">
                        <path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M33.5 0C52 0 67 15 67 33.5S52 67 33.5 67 0 52 0 33.5c.03-1.4 1.17-2.53 2.58-2.53 1.4 0 2.55 1.13 2.57 2.53 0 15.65 12.7 28.35 28.35 28.35 15.66 0 28.35-12.7 28.35-28.35 0-15.66-12.69-28.35-28.35-28.35h-.04c-7 0-13.76 2.61-18.94 7.3-.46.42-.91.85-1.34 1.29h6.58c1.42 0 2.57 1.16 2.57 2.58 0 1.42-1.15 2.58-2.57 2.58H6.01c-1.42 0-2.57-1.16-2.57-2.58V2.58C3.44 1.15 4.59 0 6.01 0c1.43 0 2.58 1.15 2.58 2.58v8.52c.78-.86 1.61-1.7 2.47-2.47A33.407 33.407 0 0 1 33.46 0h.04zm.48 41.34c-1.6-2.21-2-5.2-2-7.85 0-2.65.4-5.63 2-7.83 1.44-1.97 3.47-2.84 5.88-2.84 2.41 0 4.42.87 5.86 2.84 1.61 2.21 2.03 5.16 2.03 7.83 0 2.66-.4 5.64-2 7.85-1.43 1.97-3.47 2.84-5.89 2.84-2.41 0-4.45-.86-5.88-2.84zm-9.73-12.77l-5 1.58v-4.21l5.87-2.65h4.28v20.47h-5.15V28.57zm17.61 9.96c.61-1.33.68-3.6.68-5.04s-.07-3.7-.68-5.02c-.4-.86-1.04-1.29-2-1.29-.95 0-1.59.42-1.99 1.29-.61 1.32-.68 3.58-.68 5.02 0 1.44.07 3.71.68 5.04.4.87 1.04 1.29 1.99 1.29.96 0 1.6-.42 2-1.29z"/>
                    </svg>
                </div>
                <div class="center-btn" id="center-play-btn">
                    <svg id="icon-play" width="67" height="67" viewBox="0 0 67 67" fill="none">
                        <path fill="currentColor" d="M20.28 9.65c-2.205-1.268-4.026-.228-4.026 2.307v43.805c0 2.535 1.82 3.574 4.027 2.307l38.471-21.903a2.556 2.556 0 0 0 1.094-.935 2.514 2.514 0 0 0 0-2.743 2.556 2.556 0 0 0-1.093-.936L20.28 9.65z"/>
                    </svg>
                    <svg id="icon-pause" width="67" height="67" viewBox="0 0 67 67" fill="none" style="display:none">
                        <path fill="currentColor" fill-rule="evenodd" d="M46.332 5.773a4.125 4.125 0 0 0-4.125 4.125v46.75a4.127 4.127 0 0 0 4.125 4.125 4.127 4.127 0 0 0 4.125-4.125V9.898a4.125 4.125 0 0 0-4.125-4.125zM25.707 9.898v46.75a4.125 4.125 0 1 1-8.25 0V9.898a4.123 4.123 0 0 1 4.125-4.125 4.123 4.123 0 0 1 4.125 4.125z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="center-btn skip-btn" id="skip-forward">
                    <svg width="50" height="50" viewBox="0 0 67 67" fill="none">
                        <path fill="currentColor" fill-rule="evenodd" d="M33.5 0C15 0 0 15 0 33.5S15 67 33.5 67 67 52 67 33.5a2.583 2.583 0 0 0-2.58-2.53c-1.4 0-2.55 1.13-2.57 2.53 0 15.66-12.69 28.35-28.35 28.35-15.65 0-28.35-12.7-28.35-28.35 0-15.66 12.7-28.35 28.35-28.35 7.3 0 13.96 2.76 18.99 7.3.46.42.9.85 1.34 1.29h-6.59a2.58 2.58 0 0 0 0 5.16h13.75c1.42 0 2.57-1.16 2.57-2.58V2.58c0-1.43-1.15-2.58-2.57-2.58-1.43 0-2.58 1.15-2.58 2.58v8.52c-.78-.87-1.61-1.7-2.47-2.48A33.446 33.446 0 0 0 33.54 0h-.04zm.48 41.34c-1.6-2.21-2-5.2-2-7.85 0-2.65.4-5.63 2-7.83 1.44-1.97 3.47-2.84 5.88-2.84 2.41 0 4.42.87 5.86 2.84 1.61 2.21 2.03 5.16 2.03 7.83 0 2.66-.4 5.64-2 7.85-1.43 1.97-3.47 2.84-5.89 2.84-2.41 0-4.45-.87-5.88-2.84zm-9.73-12.77l-5 1.58v-4.21l5.87-2.65h4.28v20.47h-5.15V28.57zm17.61 9.96c.61-1.33.68-3.6.68-5.04s-.07-3.7-.68-5.02c-.4-.87-1.04-1.29-2-1.29-.95 0-1.59.42-1.99 1.29-.61 1.32-.68 3.58-.68 5.02 0 1.44.07 3.71.68 5.04.4.86 1.04 1.28 1.99 1.28.96 0 1.6-.42 2-1.28z"/>
                    </svg>
                </div>
            </div>

            <!-- BOTTOM BAR -->
            <div class="bottom-bar">
                <div class="time-row">
                    <span class="live-badge" id="live-badge">DIRECT</span>
                    <span class="live-offset" id="live-offset"></span>
                </div>
                <div class="seek-bar" id="seek-bar">
                    <div class="seek-fill" id="seek-fill"></div>
                </div>
            </div>

            <!-- Menus popup -->
            <div class="menu-popup" id="menu-subs"></div>
            <div class="menu-popup" id="menu-settings"></div>
        </div>
    </div>

    <!--
        IMPORTANT: Le Cast Framework doit être chargé EN DERNIER.
        Il appellera window.__onGCastApiAvailable() une fois prêt,
        ce qui déclenchera notre initialisation du CastProxy.
    -->
    <script>
    // ==========================================
    //  CONFIGURATION
    // ==========================================
    const CONFIG = {
        channelName: "Ligue 1+",
        mpdUrl: "https://dice-live-eu.cdnfastly.endeavorstreaming.net/1772401406_fWGJEUrHLrt4m0t2_cc8f06267003f8d29c6f6c464771dc43a4f1f4e1/id=8634412c-5377-43d2-ba6e-9f43f37a96f6/data=dWlkPXNSYnhVbnxlOGZmNWIyZS0yYzZkLTRmODctODJjZi00ZWE0MzdhNGM5OGUmaXA9MmEwMTplMGE6ZWExOjI3MjA6MzAwODo1N2Y3OjRiMzg6MTViNSZleHA9MTc3MjQwMTQzNiZlaWQ9Mjk2MzczJmNpZD1kY2UubGlndWV1biZvaWQ9MzQ2JnR5cGU9TElWRQ/dash/live/2001563~/dash/live/2001563/296373-317402/manifest-d.mpd",
        drmKeys: { "d99effb979a4482a82dbab8576bca393": "b85774149e9c4dd88767bd42fec27e79" },
        castAppId: "CC1AD845", // Default Media Receiver Google — fonctionne sans app receiver custom
    };

    // ==========================================
    //  ÉLÉMENTS DOM
    // ==========================================
    const $ = id => document.getElementById(id);
    const video        = $('video');
    const uiLayer      = $('ui-layer');
    const clickLayer   = $('click-layer');
    const iconPlay     = $('icon-play');
    const iconPause    = $('icon-pause');
    const seekBar      = $('seek-bar');
    const seekFill     = $('seek-fill');
    const volRange     = $('vol-range');
    const volIcon      = $('vol-icon');
    const subContainer = $('subtitle-container');
    const movieTitle   = $('movie-title');
    const liveBadge    = $('live-badge');
    const liveOffset   = $('live-offset');
    const castBtn      = $('cast-btn');
    const castScreen   = $('cast-screen');

    // ==========================================
    //  ÉTAT GLOBAL
    // ==========================================
    let shakaPlayer, castProxy;
    let playerReady  = false;
    let isMenuOpen   = false;
    let uiTimer      = null;
    let clickTimer   = null;

    // ==========================================
    //  UTILS: STOCKAGE & PERSISTANCE
    // ==========================================
    const storageKey = k => `live_${CONFIG.channelName.replace(/\s+/g,'_')}_${k}`;

    function savePrefs() {
        if (!playerReady) return;
        localStorage.setItem(storageKey('vol'), video.volume);
        localStorage.setItem(storageKey('muted'), video.muted);
        const activeAudio = shakaPlayer.getVariantTracks().find(t => t.active);
        const activeSub   = shakaPlayer.getTextTracks().find(t => t.active);
        if (activeAudio) localStorage.setItem(storageKey('audio'), activeAudio.language);
        if (activeSub)   localStorage.setItem(storageKey('sub'),   activeSub.language);
        localStorage.setItem(storageKey('subs_on'), shakaPlayer.isTextTrackVisible());
    }

    function loadPrefs() {
        const vol = localStorage.getItem(storageKey('vol'));
        if (vol !== null) {
            video.volume = parseFloat(vol);
            volRange.value = vol;
        }
        const muted = localStorage.getItem(storageKey('muted'));
        if (muted === 'true') video.muted = true;
        updateVolIcon();
    }

    function applyAVPrefs() {
        const audio  = localStorage.getItem(storageKey('audio'))  || 'fr';
        const sub    = localStorage.getItem(storageKey('sub'))     || 'fr';
        const subsOn = localStorage.getItem(storageKey('subs_on')) !== 'false';
        shakaPlayer.selectAudioLanguage(audio);
        shakaPlayer.selectTextLanguage(sub);
        shakaPlayer.setTextTrackVisibility(subsOn);
    }

    // ==========================================
    //  UTILS: FORMATAGE
    // ==========================================
    function formatOffset(sec) {
        if (sec >= 0) return "";
        const a = Math.abs(Math.floor(sec));
        const h = Math.floor(a / 3600);
        const m = Math.floor((a % 3600) / 60);
        const s = a % 60;
        const pad = n => n < 10 ? '0' + n : n;
        return h > 0 ? `-${h}:${pad(m)}:${pad(s)}` : `-${pad(m)}:${pad(s)}`;
    }

    function getAudioLabel(track, onlyOneTrack) {
        if (onlyOneTrack) return 'Piste Originale';
        const lang = (track.language || '').toLowerCase();
        if (lang === 'qtz' || lang === 'qaa') return 'Audio Description';
        if (track.label) return track.label;
        const map = { fr: 'Français', en: 'English', de: 'Deutsch', es: 'Español', it: 'Italiano' };
        return map[lang] || lang.toUpperCase();
    }

    // ==========================================
    //  UI VISIBILITY
    // ==========================================
    function showUI() {
        uiLayer.classList.add('visible');
        subContainer.classList.add('shifted');
        document.body.classList.remove('hide-cursor');
        clearTimeout(uiTimer);
        if (!video.paused && !isMenuOpen) {
            uiTimer = setTimeout(hideUI, 5000);
        }
    }

    function hideUI() {
        if (isMenuOpen) return;
        uiLayer.classList.remove('visible');
        subContainer.classList.remove('shifted');
        document.body.classList.add('hide-cursor');
    }

    // ==========================================
    //  VOLUME
    // ==========================================
    const VOL_SVGS = {
        mute: `<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 20V4L8.115 7.934A.5.5 0 0 1 7.867 8H3.5a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5h4.367a.5.5 0 0 1 .248.066L15 20zm5-17L4 21"/><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.11 7.014L4.08 23.922"/>`,
        low:  `<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 20V4L8.115 7.934A.5.5 0 0 1 7.867 8H3.5a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5h4.367a.5.5 0 0 1 .248.066L15 20z"/>`,
        med:  `<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 20V4L8.115 7.934A.5.5 0 0 1 7.867 8H3.5a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5h4.367a.5.5 0 0 1 .248.066L15 20z"/><path fill="currentColor" d="M17.5 12a2 2 0 0 1-2 2v-4a2 2 0 0 1 2 2z"/>`,
        high: `<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 20V4L8.115 7.934A.5.5 0 0 1 7.867 8H3.5a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5h4.367a.5.5 0 0 1 .248.066L15 20z"/><path fill="currentColor" d="M17.5 12a2 2 0 0 1-2 2v-4a2 2 0 0 1 2 2z"/><path fill="currentColor" fill-rule="evenodd" d="M18.536 7.08a.75.75 0 0 1 1.053.125A7.72 7.72 0 0 1 21.25 12a7.72 7.72 0 0 1-1.661 4.795.75.75 0 1 1-1.178-.929A6.22 6.22 0 0 0 19.75 12c0-1.46-.5-2.802-1.339-3.866a.75.75 0 0 1 .125-1.053z" clip-rule="evenodd"/>`,
        max:  `<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 20V4L8.115 7.934A.5.5 0 0 1 7.867 8H3.5a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5h4.367a.5.5 0 0 1 .248.066L15 20z"/><path fill="currentColor" d="M17.5 12a2 2 0 0 1-2 2v-4a2 2 0 0 1 2 2z"/><path fill="currentColor" fill-rule="evenodd" d="M18.536 7.08a.75.75 0 0 1 1.053.125A7.72 7.72 0 0 1 21.25 12a7.72 7.72 0 0 1-1.661 4.795.75.75 0 1 1-1.178-.929A6.22 6.22 0 0 0 19.75 12c0-1.46-.5-2.802-1.339-3.866a.75.75 0 0 1 .125-1.053z" clip-rule="evenodd"/><path fill="currentColor" fill-rule="evenodd" d="M20.524 4.438a.75.75 0 0 1 1.055.103 11.705 11.705 0 0 1 2.671 7.46c0 2.83-1.002 5.43-2.67 7.458a.75.75 0 1 1-1.16-.953A10.205 10.205 0 0 0 22.75 12a10.2 10.2 0 0 0-2.33-6.506.75.75 0 0 1 .104-1.056z" clip-rule="evenodd"/>`,
    };

    function updateVolIcon() {
        const v = video.muted ? 0 : video.volume;
        if (v === 0)      volIcon.innerHTML = VOL_SVGS.mute;
        else if (v < 0.3) volIcon.innerHTML = VOL_SVGS.low;
        else if (v < 0.6) volIcon.innerHTML = VOL_SVGS.med;
        else if (v < 0.9) volIcon.innerHTML = VOL_SVGS.high;
        else              volIcon.innerHTML = VOL_SVGS.max;
    }

    function adjustVolume(delta) {
        video.volume = Math.min(1, Math.max(0, video.volume + delta));
        video.muted  = false;
        volRange.value = video.volume;
        updateVolIcon();
        savePrefs();
    }

    // ==========================================
    //  LECTURE
    // ==========================================
    function updatePlayIcon() {
        iconPlay.style.display  = video.paused ? 'block' : 'none';
        iconPause.style.display = video.paused ? 'none'  : 'block';
    }

    function togglePlay() {
        if (!playerReady) return;
        video.paused ? video.play() : video.pause();
        updatePlayIcon();
        showUI();
    }

    function skip(seconds) {
        if (!playerReady || !shakaPlayer) return;
        const range = shakaPlayer.seekRange();
        if (!range) return;
        video.currentTime = Math.max(range.start, Math.min(range.end, video.currentTime + seconds));
        showUI();
    }

    function seekToLive() {
        if (!playerReady || !shakaPlayer) return;
        const range = shakaPlayer.seekRange();
        if (!range) return;
        video.currentTime = range.end;
        if (video.paused) video.play();
        updatePlayIcon();
        showUI();
    }

    // ==========================================
    //  BARRE DE PROGRESSION
    // ==========================================
    video.addEventListener('timeupdate', () => {
        if (!playerReady || !shakaPlayer) return;
        const range = shakaPlayer.seekRange();
        if (!range) return;
        const duration = range.end - range.start;
        const pos      = video.currentTime - range.start;
        seekFill.style.width = duration > 0 ? (pos / duration * 100) + '%' : '100%';

        const offset = video.currentTime - range.end;
        if (offset > -12) {
            liveBadge.classList.remove('delayed');
            liveOffset.textContent = '';
        } else {
            liveBadge.classList.add('delayed');
            liveOffset.textContent = formatOffset(offset);
        }
    });

    seekBar.addEventListener('click', e => {
        if (!playerReady || !shakaPlayer) return;
        e.stopPropagation();
        const rect  = seekBar.getBoundingClientRect();
        const range = shakaPlayer.seekRange();
        if (!range) return;
        const ratio = (e.clientX - rect.left) / rect.width;
        video.currentTime = range.start + ratio * (range.end - range.start);
    });

    // ==========================================
    //  MENUS POPUP
    // ==========================================
    function closeAllMenus() {
        document.querySelectorAll('.menu-popup').forEach(m => m.classList.remove('open'));
        isMenuOpen = false;
    }

    function toggleMenu(id) {
        if (!playerReady) return;
        const menu    = $(id);
        const wasOpen = menu.classList.contains('open');
        closeAllMenus();
        if (!wasOpen) {
            buildMenu(id);
            menu.classList.add('open');
            isMenuOpen = true;
            clearTimeout(uiTimer);
            showUI();
        }
    }

    document.addEventListener('click', e => {
        if (isMenuOpen && !e.target.closest('.menu-popup') && !e.target.closest('#subs-btn') && !e.target.closest('#settings-btn')) {
            closeAllMenus();
        }
    });

    function makeMenuItem(label, subLabel, isActive, onClick) {
        const btn = document.createElement('button');
        btn.className = 'menu-item' + (isActive ? ' active' : '');
        btn.innerHTML = label + (subLabel ? `<span class="menu-sub">${subLabel}</span>` : '');
        btn.onclick = onClick;
        return btn;
    }

    function buildMenu(id) {
        const menu = $(id);
        menu.innerHTML = '';
        if (!shakaPlayer || !playerReady) return;

        if (id === 'menu-subs') {
            menu.innerHTML = '<div class="menu-header">Sous-titres & Audio</div>';

            // -- SOUS-TITRES --
            const secSub = document.createElement('div');
            secSub.className = 'menu-section'; secSub.textContent = 'Sous-titres';
            menu.appendChild(secSub);

            const subsVisible = shakaPlayer.isTextTrackVisible();
            menu.appendChild(makeMenuItem('Désactivé', null, !subsVisible, () => {
                shakaPlayer.setTextTrackVisibility(false);
                savePrefs(); closeAllMenus();
            }));

            shakaPlayer.getTextTracks().forEach(track => {
                const labels = { fr: 'Français', en: 'English' };
                const label  = labels[track.language] || track.language.toUpperCase();
                const active = subsVisible && shakaPlayer.getTextLanguages()[0] === track.language;
                menu.appendChild(makeMenuItem(label, null, active, () => {
                    shakaPlayer.selectTextLanguage(track.language);
                    shakaPlayer.setTextTrackVisibility(true);
                    savePrefs(); closeAllMenus();
                }));
            });

            const sep = document.createElement('div'); sep.className = 'menu-sep';
            menu.appendChild(sep);

            // -- AUDIO --
            const secAudio = document.createElement('div');
            secAudio.className = 'menu-section'; secAudio.textContent = 'Audio';
            menu.appendChild(secAudio);

            const allTracks = shakaPlayer.getVariantTracks();
            const langs     = [...new Set(allTracks.map(t => t.language))];
            const onlyOne   = langs.length === 1;
            const activeLang = (allTracks.find(t => t.active) || {}).language;

            langs.forEach(lang => {
                const track = allTracks.find(t => t.language === lang);
                const label = getAudioLabel(track, onlyOne);
                menu.appendChild(makeMenuItem(label, null, activeLang === lang, () => {
                    shakaPlayer.selectAudioLanguage(lang);
                    savePrefs(); closeAllMenus();
                }));
            });

        } else if (id === 'menu-settings') {
            menu.innerHTML = '<div class="menu-header">Qualité vidéo</div>';

            // Option Auto
            const abrOn = shakaPlayer.getConfiguration().abr.enabled;
            menu.appendChild(makeMenuItem('Automatique', 'Adaptée à votre connexion', abrOn, () => {
                shakaPlayer.configure({ abr: { enabled: true } });
                closeAllMenus();
            }));

            const sepQ = document.createElement('div'); sepQ.className = 'menu-sep';
            menu.appendChild(sepQ);

            const tracks = shakaPlayer.getVariantTracks().sort((a,b) => b.height - a.height);
            const seen   = new Set();

            tracks.forEach(t => {
                if (!t.height || seen.has(t.height)) return;
                seen.add(t.height);
                const qualityMap = {
                    label: t.height >= 1080 ? 'HD 1080p' : t.height >= 720 ? 'HD 720p' : t.height >= 480 ? 'SD 480p' : `${t.height}p`,
                    sub:   t.height >= 1080 ? 'Environ 1,2 Go/h'
                         : t.height >= 720  ? 'Environ 0,9 Go/h'
                         : t.height >= 480  ? 'Environ 0,4 Go/h'
                         : 'Faible débit',
                };
                const isActive = t.active && !abrOn;
                menu.appendChild(makeMenuItem(qualityMap.label, qualityMap.sub, isActive, () => {
                    shakaPlayer.configure({ abr: { enabled: false } });
                    shakaPlayer.selectVariantTrack(t, true);
                    closeAllMenus();
                }));
            });
        }
    }

    // ==========================================
    //  FULLSCREEN & PiP
    // ==========================================
    function toggleFullscreen() {
        if (!document.fullscreenElement) $('player-container').requestFullscreen().catch(()=>{});
        else document.exitFullscreen().catch(()=>{});
    }

    // ==========================================
    //  CLAVIER
    // ==========================================
    window.addEventListener('keydown', e => {
        if (!playerReady) return;
        const actions = {
            'Space':       () => { e.preventDefault(); togglePlay(); },
            'ArrowRight':  () => { e.preventDefault(); skip(10); },
            'ArrowLeft':   () => { e.preventDefault(); skip(-10); },
            'ArrowUp':     () => { e.preventDefault(); adjustVolume(0.1); },
            'ArrowDown':   () => { e.preventDefault(); adjustVolume(-0.1); },
            'KeyF':        () => toggleFullscreen(),
            'KeyM':        () => { video.muted = !video.muted; updateVolIcon(); },
        };
        if (actions[e.code]) actions[e.code]();
        showUI();
    });

    // ==========================================
    //  SOURIS
    // ==========================================
    clickLayer.addEventListener('mousemove', showUI);
    uiLayer.addEventListener('mousemove', () => {
        clearTimeout(uiTimer);
        document.body.classList.remove('hide-cursor');
        uiLayer.classList.add('visible');
    });

    clickLayer.addEventListener('click', () => {
        if (!playerReady) return;
        if (clickTimer) {
            clearTimeout(clickTimer);
            clickTimer = null;
            toggleFullscreen();
        } else {
            clickTimer = setTimeout(() => {
                clickTimer = null;
                togglePlay();
            }, 240);
        }
    });

    // ==========================================
    //  SÉCURITÉ
    // ==========================================
    function checkSecurity() {
        if (!window.isSecureContext) {
            $('security-warning').style.display = 'flex';
            return false;
        }
        return true;
    }

    // ==========================================
    //  CAST
    // ==========================================
    /**
     * Initialise le CastProxy de Shaka APRÈS que le Cast Framework
     * soit prêt (window.__onGCastApiAvailable a été appelé).
     *
     * Corrections apportées :
     * 1. Le bouton cast est masqué (hidden-cast) jusqu'à ce que l'API soit prête
     * 2. castProxy.cast() déclenche correctement le sélecteur de TV natif
     * 3. Les events 'caststatuschanged' pilotent l'écran d'attente ET la sync play/pause
     * 4. Les erreurs sont gérées proprement
     */
    function initCast() {
        if (!window.cast || !window.cast.framework) return;

        try {
            // Shaka CastProxy proxifie complètement le lecteur → la TV reçoit toutes les commandes
            castProxy = new shaka.cast.CastProxy(video, shakaPlayer, CONFIG.castAppId);

            castProxy.addEventListener('caststatuschanged', () => {
                const casting = castProxy.isCasting();

                castBtn.classList.toggle('active', casting);
                casting ? castScreen.classList.add('visible') : castScreen.classList.remove('visible');

                // Synchroniser l'icône play/pause avec l'état réel
                updatePlayIcon();

                // Continuer de mettre à jour l'UI pendant le cast
                showUI();
            });

            // Activer le bouton maintenant que l'API est disponible
            castBtn.classList.remove('hidden-cast');

            castBtn.addEventListener('click', e => {
                e.stopPropagation();
                if (castProxy.isCasting()) {
                    castProxy.suggestDisconnect();
                } else {
                    castProxy.cast().catch(err => {
                        // L'utilisateur a annulé le dialogue → pas une vraie erreur
                        if (err.code !== shaka.util.Error.Code.CAST_CANCELED_BY_USER) {
                            console.error('Erreur Cast:', err);
                        }
                    });
                }
            });

        } catch (err) {
            console.warn('Impossible d\'initialiser le Cast:', err);
        }
    }

    // Ce callback est appelé automatiquement par le Cast Framework quand il est prêt
    window['__onGCastApiAvailable'] = function(isAvailable) {
        if (isAvailable && shakaPlayer) {
            initCast();
        }
    };

    // ==========================================
    //  INITIALISATION PRINCIPALE
    // ==========================================
    async function init() {
        if (!checkSecurity()) return;
        movieTitle.textContent = CONFIG.channelName;
        updateVolIcon();

        shaka.polyfill.installAll();

        if (!shaka.Player.isBrowserSupported()) {
            $('security-warning').querySelector('p').textContent = 'Navigateur non supporté pour la lecture HLS/DASH.';
            $('security-warning').style.display = 'flex';
            return;
        }

        shakaPlayer = new shaka.Player(video);

        shakaPlayer.configure({
            streaming: {
                alwaysStreamText: true,
                bufferingGoal: 30,
                rebufferingGoal: 5,
            },
            textDisplayFactory: () => new shaka.text.UITextDisplayer(video, subContainer),
            drm: { clearKeys: CONFIG.drmKeys },
            abr: { enabled: true },
        });

        shakaPlayer.addEventListener('error', e => console.error('Shaka error:', e.detail));

        try {
            await shakaPlayer.load(CONFIG.mpdUrl);
            playerReady = true;
            loadPrefs();

            // Appliquer les préférences A/V après un court délai (pistes pas toujours dispo immédiatement)
            setTimeout(applyAVPrefs, 600);

            showUI();

            // Si le Cast Framework est déjà prêt avant la fin du load (rare mais possible)
            if (window.cast && window.cast.framework && !castProxy) {
                initCast();
            }

        } catch (err) {
            console.error('Erreur de chargement:', err);
            playerReady = false;
        }
    }

    // ==========================================
    //  EVENT LISTENERS
    // ==========================================
    document.addEventListener('DOMContentLoaded', init);

    $('center-play-btn').addEventListener('click', e => { e.stopPropagation(); togglePlay(); });
    $('skip-back').addEventListener('click',       e => { e.stopPropagation(); skip(-10); });
    $('skip-forward').addEventListener('click',    e => { e.stopPropagation(); skip(10); });
    $('subs-btn').addEventListener('click',        e => { e.stopPropagation(); toggleMenu('menu-subs'); });
    $('settings-btn').addEventListener('click',    e => { e.stopPropagation(); toggleMenu('menu-settings'); });
    $('live-badge').addEventListener('click',      e => { e.stopPropagation(); seekToLive(); });

    $('vol-btn').addEventListener('click', e => {
        e.stopPropagation();
        video.muted = !video.muted;
        updateVolIcon();
        savePrefs();
    });

    $('vol-range').addEventListener('input', e => {
        video.volume   = parseFloat(e.target.value);
        video.muted    = video.volume === 0;
        updateVolIcon();
        savePrefs();
    });

    $('pip-btn').addEventListener('click', e => {
        e.stopPropagation();
        if (!playerReady) return;
        document.pictureInPictureElement
            ? document.exitPictureInPicture()
            : video.requestPictureInPicture().catch(()=>{});
    });

    $('fullscreen-btn').addEventListener('click', e => { e.stopPropagation(); toggleFullscreen(); });

    video.addEventListener('play',  updatePlayIcon);
    video.addEventListener('pause', updatePlayIcon);
    </script>

    <!--
        Cast Framework chargé EN DERNIER, après tout le JS.
        Le paramètre loadCastFramework=1 charge le Cast Application Framework (CAF).
        __onGCastApiAvailable sera déclenché une fois que google cast sdk est disponible.
    -->
    <script defer src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</body>
</html>
