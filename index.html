<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Catalogue Moovies</title>
    <style>
        :root { --bg: #0b0b0b; --card: #161616; --accent: #e50914; --input: #222; }
        body { background: var(--bg); color: white; font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 20px; }
        
        header { max-width: 1400px; margin: 0 auto 40px; text-align: center; }
        h1 { color: var(--accent); text-transform: uppercase; letter-spacing: 4px; margin-bottom: 30px; }

        /* Barre de recherche et Filtres */
        .controls { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 30px; }
        #searchBar { 
            padding: 12px 20px; width: 300px; border-radius: 25px; border: none; 
            background: var(--input); color: white; outline: none; font-size: 1em;
        }
        #genreFilter { 
            padding: 10px 20px; border-radius: 25px; border: none; 
            background: var(--input); color: white; outline: none; cursor: pointer;
        }

        /* Grille */
        #catalog { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 20px; max-width: 1400px; margin: 0 auto; 
        }
        
        .movie-card { 
            background: var(--card); border-radius: 8px; overflow: hidden; 
            transition: transform 0.3s ease; text-decoration: none; color: inherit; display: block;
            box-shadow: 0 8px 15px rgba(0,0,0,0.5);
        }
        
        .movie-card.hidden { display: none; }
        .movie-card:hover { transform: scale(1.05); border: 1px solid var(--accent); }
        .movie-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; display: block; }
        
        .info { padding: 10px; text-align: center; }
        .title { display: block; font-weight: bold; font-size: 0.85em; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .meta { color: #888; font-size: 0.75em; }

        .loader { text-align: center; font-size: 1.2em; color: #666; margin-top: 50px; width: 100%; }
    </style>
</head>
<body>

    <header>
        <h1>MON CATALOGUE</h1>
        <div class="controls">
            <input type="text" id="searchBar" placeholder="Rechercher un film..." oninput="filterMovies()">
            <select id="genreFilter" onchange="filterMovies()">
                <option value="all">Toutes les catégories</option>
            </select>
        </div>
    </header>

    <div id="catalog" class="loader">Chargement des films...</div>

    <script>
        const API_GITHUB = 'https://api.github.com/repos/Cyprdu/movies-tmdb/contents/';
        const BASE_URL_NETLIFY = 'https://moovies-mpd.netlify.app/info?';
        const TMDB_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI0YmM5NGE4NTk4ODgzZjNhYTgyM2IxZWZmNjUzNmE5ZSIsIm5iZiI6MTc2OTAxNTQ2OS44NDgsInN1YiI6IjY5NzEwOGFkYmM1ODc1OWVkYzA4ZGE2ZCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.IyDx0X9qH6RIAPdxwODeMSZKMBgMxu07Gg6TgZZOCMw';

        let moviesData = []; 
        const genresMap = new Set();

        async function loadCatalog() {
            try {
                const response = await fetch(API_GITHUB);
                const files = await response.json();

                const ids = files
                    .filter(f => f.name.endsWith('.html') && /^\d+$/.test(f.name.split('.')[0]))
                    .map(f => f.name.split('.')[0]);

                if (ids.length === 0) {
                    document.getElementById('catalog').innerHTML = "Aucun film trouvé.";
                    return;
                }

                const promises = ids.map(id => fetchTMDB(id));
                const results = await Promise.all(promises);
                
                moviesData = results.filter(m => m !== null);
                renderCatalog(moviesData);
                populateGenres();

            } catch (error) {
                document.getElementById('catalog').innerHTML = "⚠️ Erreur de chargement : " + error.message;
            }
        }

        async function fetchTMDB(id) {
            try {
                const res = await fetch(`https://api.themoviedb.org/3/movie/${id}?language=fr-FR`, {
                    headers: { Authorization: `Bearer ${TMDB_TOKEN}` }
                });
                const data = await res.json();
                
                if (!data.title) return null;

                data.genres.forEach(g => genresMap.add(g.name));

                return {
                    id: id,
                    title: data.title,
                    poster: data.poster_path,
                    year: data.release_date ? data.release_date.split('-')[0] : 'N/A',
                    genres: data.genres.map(g => g.name)
                };
            } catch (e) { return null; }
        }

        function renderCatalog(movies) {
            const catalog = document.getElementById('catalog');
            catalog.innerHTML = '';
            catalog.classList.remove('loader');

            movies.forEach(movie => {
                const card = document.createElement('a');
                // Lien modifié ici pour pointer vers /info?ID
                card.href = `${BASE_URL_NETLIFY}${movie.id}`;
                card.className = 'movie-card';
                card.dataset.title = movie.title.toLowerCase();
                card.dataset.genres = movie.genres.join('|').toLowerCase();
                
                card.innerHTML = `
                    <img src="https://image.tmdb.org/t/p/w500${movie.poster}" alt="${movie.title}">
                    <div class="info">
                        <span class="title">${movie.title}</span>
                        <span class="meta">${movie.year} • ${movie.genres[0] || 'Film'}</span>
                    </div>
                `;
                catalog.appendChild(card);
            });
        }

        function populateGenres() {
            const select = document.getElementById('genreFilter');
            const sortedGenres = Array.from(genresMap).sort();
            sortedGenres.forEach(genre => {
                const opt = document.createElement('option');
                opt.value = genre.toLowerCase();
                opt.textContent = genre;
                select.appendChild(opt);
            });
        }

        function filterMovies() {
            const searchTerm = document.getElementById('searchBar').value.toLowerCase();
            const selectedGenre = document.getElementById('genreFilter').value;
            const cards = document.querySelectorAll('.movie-card');

            cards.forEach(card => {
                const titleMatch = card.dataset.title.includes(searchTerm);
                const genreMatch = selectedGenre === 'all' || card.dataset.genres.includes(selectedGenre);
                
                if (titleMatch && genreMatch) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        }

        loadCatalog();
    </script>
</body>
</html>
