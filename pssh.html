<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extracteur MPD via URL</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; max-width: 900px; margin: 20px auto; padding: 20px; background: #f0f2f5; }
        .container { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        button { padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background: #1976D2; }
        textarea { width: 100%; height: 250px; font-family: 'Consolas', monospace; margin-top: 10px; border: 1px solid #eee; background: #fafafa; padding: 10px; box-sizing: border-box; }
        .result { background: #fff; border: 2px solid #2196F3; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .label { font-weight: bold; color: #2196F3; display: block; margin-bottom: 5px; }
        .error { color: #d32f2f; background: #fdecea; padding: 10px; border-radius: 6px; margin-top: 10px; display: none; }
        code { background: #f4f4f4; padding: 2px 5px; border-radius: 4px; word-break: break-all; }
    </style>
</head>
<body>

<div class="container">
    <h2>Analyseur DASH MPD via URL</h2>
    <p>Entrez l'URL de votre manifeste .mpd :</p>
    
    <div class="input-group">
        <input type="text" id="urlInput" placeholder="https://example.com/video/manifest.mpd" value="">
        <button onclick="fetchMPD()">Analyser</button>
    </div>

    <div id="errorMessage" class="error"></div>

    <div id="output" style="display:none;">
        <span class="label">Contenu du MPD :</span>
        <textarea id="fileContent" readonly></textarea>

        <div class="result">
            <p><span class="label">KID Extrait (Hex) :</span> <code id="kidDisplay"></code></p>
            <p><span class="label">PSSH Widevine (Base64) :</span> <code id="psshDisplay"></code></p>
        </div>
    </div>
</div>

<script>
    async function fetchMPD() {
        const url = document.getElementById('urlInput').value;
        const errorDiv = document.getElementById('errorMessage');
        const outputDiv = document.getElementById('output');
        
        errorDiv.style.display = 'none';
        if (!url) return;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
            
            const content = await response.text();
            document.getElementById('fileContent').value = content;
            outputDiv.style.display = 'block';
            
            extractAndGenerate(content);
        } catch (err) {
            errorDiv.textContent = "Erreur : Impossible de récupérer le fichier. Vérifiez l'URL ou les restrictions CORS. " + err.message;
            errorDiv.style.display = 'block';
            outputDiv.style.display = 'none';
        }
    }

    function extractAndGenerate(xmlString) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "text/xml");
        
        // Recherche du KID (supporte les namespaces cenc)
        let kid = "";
        const cpTag = Array.from(xmlDoc.querySelectorAll("ContentProtection")).find(el => 
            el.getAttribute("cenc:default_KID") || el.getAttribute("default_KID")
        );

        if (cpTag) {
            kid = cpTag.getAttribute("cenc:default_KID") || cpTag.getAttribute("default_KID");
        }

        if (kid) {
            document.getElementById('kidDisplay').textContent = kid;
            document.getElementById('psshDisplay').textContent = generateWidevinePssh(kid);
        } else {
            document.getElementById('kidDisplay').textContent = "Non trouvé";
            document.getElementById('psshDisplay').textContent = "N/A";
        }
    }

    function generateWidevinePssh(kid) {
        // Nettoyage du KID
        const hexKid = kid.replace(/-/g, '').toLowerCase();
        const systemId = "edef8ba979d64acea3c827dcd51d21ed";
        
        // Data Widevine (08011210 + KID)
        const psshData = "08011210" + hexKid;
        const dataLength = psshData.length / 2;
        const totalSize = 32 + dataLength;
        
        let psshHex = totalSize.toString(16).padStart(8, '0') 
                    + "70737368" // 'pssh'
                    + "00000000" // version 0
                    + systemId 
                    + dataLength.toString(16).padStart(8, '0') 
                    + psshData;

        return hexToBase64(psshHex);
    }

    function hexToBase64(hex) {
        return btoa(hex.match(/\w{2}/g).map(a => String.fromCharCode(parseInt(a, 16))).join(""));
    }
</script>

</body>
</html>
